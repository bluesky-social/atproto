import * as url from 'url'
import { readFileSync, writeFileSync } from 'fs'
import { join } from 'path'
import * as prettier from 'prettier'

const __dirname = url.fileURLToPath(new URL('.', import.meta.url))

const labelsDef = JSON.parse(
  readFileSync(
    join(__dirname, '..', '..', 'definitions', 'labels.json'),
    'utf8',
  ),
)

writeFileSync(
  join(__dirname, '..', '..', 'src', 'moderation', 'const', 'labels.ts'),
  await gen(),
  'utf8',
)

async function gen() {
  return prettier.format(
    `/** this doc is generated by ./scripts/code/labels.mjs **/
  import {LabelDefinition} from '../types'

  export type KnownLabelValue = ${labelsDef
    .map((group) => group.labels)
    .flat()
    .map((label) => `"${label.id}"`)
    .join(' | ')}

  export const LABELS: Record<KnownLabelValue, LabelDefinition> = ${JSON.stringify(
    genDefMap(),
    null,
    2,
  )}
  `,
    { semi: false, parser: 'babel', singleQuote: true },
  )
}

function genDefMap() {
  const labels = {}
  for (const group of labelsDef) {
    for (const label of group.labels) {
      labels[label.id] = {
        ...label,
        groupId: group.id,
        configurable: group.configurable,
      }
    }
  }
  return labels
}

export {}
