import { Options as PrettierOptions, format as prettierFormat } from 'prettier'

const DEFAULT_FORMAT_OPTIONS: PrettierOptions = {
  parser: 'typescript',
  tabWidth: 2,
  semi: false,
  singleQuote: true,
  trailingComma: 'es5',
}

const DEFAULT_BANNER = `/*
 * THIS FILE WAS GENERATED THROUGH "@atproto/lex". DO NOT EDIT THIS FILE DIRECTLY.
 */`

export type TsFormatterOptions = {
  /** @default false */
  format?: boolean | PrettierOptions
  banner?: string
}

export class TsFormatter {
  readonly banner: string
  readonly prettierOptions: PrettierOptions | null

  constructor(options: TsFormatterOptions = {}) {
    this.banner = options?.banner ?? DEFAULT_BANNER

    this.prettierOptions =
      options?.format === true
        ? DEFAULT_FORMAT_OPTIONS
        : options?.format || null
  }

  async format(code: string) {
    const bannerPadding =
      this.banner && !this.banner.endsWith('\n') ? '\n\n' : ''
    const codePretty = this.prettierOptions
      ? await prettierFormat(code, this.prettierOptions)
      : code
    return `${this.banner}${bannerPadding}${codePretty}`
  }
}
