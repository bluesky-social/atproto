name: Build and Publish PDS Tarball

on:
  push:
    branches:
      - main
    paths:
      - 'packages/pds/**'
      - 'packages/common/**'
      - 'packages/common-web/**'
      - 'packages/api/**'
      - 'packages/xrpc-server/**'
      - 'packages/oauth-provider/**'
      - 'pnpm-lock.yaml'
  workflow_dispatch:
    inputs:
      skip_pds_trigger:
        description: 'Skip triggering PDS build'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.9'

jobs:
  build-tarball:
    runs-on: ubuntu-latest
    outputs:
      tarball_url: ${{ steps.tarball.outputs.tarball_url }}
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Get version info
        id: version
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          PDS_VERSION=$(node -p "require('./packages/pds/package.json').version")
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "version=$PDS_VERSION" >> $GITHUB_OUTPUT
          echo "tag=pds-build-$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Pack PDS tarball
        id: pack
        run: |
          cd packages/pds
          pnpm pack --pack-destination /tmp/
          # pnpm pack creates atproto-pds-{version}.tgz
          TARBALL_PATH=$(ls /tmp/atproto-pds-*.tgz | head -1)
          TARBALL_NAME=$(basename "$TARBALL_PATH")
          echo "tarball_path=$TARBALL_PATH" >> $GITHUB_OUTPUT
          echo "tarball_name=$TARBALL_NAME" >> $GITHUB_OUTPUT

      - name: Create Release
        id: release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: pds-build-${{ steps.version.outputs.short_sha }}
          name: PDS Build ${{ steps.version.outputs.short_sha }}
          body: |
            Automated PDS tarball build from commit ${{ github.sha }}

            PDS Version: ${{ steps.version.outputs.version }}
            Commit: ${{ steps.version.outputs.short_sha }}
          files: ${{ steps.pack.outputs.tarball_path }}
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get tarball URL
        id: tarball
        run: |
          TARBALL_URL="https://github.com/${{ github.repository }}/releases/download/pds-build-${{ steps.version.outputs.short_sha }}/${{ steps.pack.outputs.tarball_name }}"
          echo "tarball_url=$TARBALL_URL" >> $GITHUB_OUTPUT

      - name: Build Summary
        run: |
          echo "## PDS Tarball Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ steps.version.outputs.short_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tarball | [${{ steps.pack.outputs.tarball_name }}](${{ steps.tarball.outputs.tarball_url }}) |" >> $GITHUB_STEP_SUMMARY

  trigger-pds:
    needs: build-tarball
    if: ${{ github.event.inputs.skip_pds_trigger != 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Trigger PDS build
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repository: w-social-eu/pds
          event-type: atproto-updated
          client-payload: |
            {
              "atproto_sha": "${{ github.sha }}",
              "atproto_short_sha": "${{ needs.build-tarball.outputs.short_sha }}",
              "tarball_url": "${{ needs.build-tarball.outputs.tarball_url }}",
              "pds_version": "${{ needs.build-tarball.outputs.version }}"
            }

      - name: Trigger Summary
        run: |
          echo "## PDS Build Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered PDS repo with tarball URL:" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ needs.build-tarball.outputs.tarball_url }}\`" >> $GITHUB_STEP_SUMMARY
